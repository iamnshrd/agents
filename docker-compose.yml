services:
  session:
    image: polymarket-agents:latest
    container_name: agents-session
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./logs:/home/logs
    command: >
      sh -c "python -c 'from agents.application.dry_run_trader import DryRunTrader; t=DryRunTrader(); t.run_session(num_trades=999999, pause_secs=10)'"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os, time, sys; p=\"/home/logs/trading.log\"; sys.exit(0 if (os.path.exists(p) and time.time()-os.path.getmtime(p) < 600) else 1)' "]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  telegram:
    image: polymarket-agents:latest
    container_name: agents-telegram
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./logs:/home/logs
    command: >
      sh -c "python -c 'import asyncio; from agents.connectors.telegram import telegram_bot_poll; asyncio.run(telegram_bot_poll())'"

  api:
    image: polymarket-agents:latest
    container_name: agents-api
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8000:8000"
    command: >
      sh -c "uvicorn scripts.python.server:app --host 0.0.0.0 --port 8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  default:
    driver: bridge


